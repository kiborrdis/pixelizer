"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){function n(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var InteractionEventType,__assign=function(){return(__assign=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};!function(t){t[t.PressStart=1]="PressStart",t[t.MoveDuringPress=2]="MoveDuringPress",t[t.PressStop=3]="PressStop",t[t.Press=4]="Press",t[t.Move=5]="Move",t[t.DoublePress=6]="DoublePress",t[t.Increase=7]="Increase",t[t.Decrease=8]="Decrease"}(InteractionEventType||(InteractionEventType={}));var InteractionAdapter=function(){function t(){for(var t in this.listeners=new Map,InteractionEventType)isNaN(Number(t))&&this.listeners.set(InteractionEventType[t],[])}return t.prototype.addInteractionListener=function(t,e){this.listeners.get(t).push(e)},t.prototype.emitInteractionEvent=function(e){this.listeners.get(e.type).forEach(function(t){t(e)})},t}(),InteractionConnector=function(){function t(t){var e=this;this.handlePressStart=function(t){e.handler&&e.handler.pressStart&&e.handler.pressStart(t)},this.handleMoveDuringPress=function(t){e.handler&&e.handler.moveDuringPress&&e.handler.moveDuringPress(t)},this.handlePressStop=function(t){e.handler&&e.handler.pressStop&&e.handler.pressStop(t)},this.handleMove=function(t){e.handler&&e.handler.move&&e.handler.move(t)},this.handlePress=function(t){e.handler&&e.handler.press&&e.handler.press(t)},this.handleDoublePress=function(t){e.handler&&e.handler.doublePress&&e.handler.doublePress(t)},this.handleIncrease=function(t){e.handler&&e.handler.increase&&e.handler.increase(t)},this.handleDecrease=function(t){e.handler&&e.handler.decrease&&e.handler.decrease(t)},(this.emitter=t).addInteractionListener(InteractionEventType.PressStart,this.handlePressStart),t.addInteractionListener(InteractionEventType.MoveDuringPress,this.handleMoveDuringPress),t.addInteractionListener(InteractionEventType.PressStop,this.handlePressStop),t.addInteractionListener(InteractionEventType.Move,this.handleMove),t.addInteractionListener(InteractionEventType.Press,this.handlePress),t.addInteractionListener(InteractionEventType.DoublePress,this.handleDoublePress),t.addInteractionListener(InteractionEventType.Increase,this.handleIncrease),t.addInteractionListener(InteractionEventType.Decrease,this.handleDecrease)}return t.prototype.setIteractionHandler=function(t){this.handler=t},t}(),InteractionRecord=function(){function t(){}return t.prototype.serialize=function(){return{type:this.constructor.name}},t}(),Tool=function(){function t(){}return t.prototype.applyToContext=function(t,e,n){throw new Error("passed record type is not supported")},t.prototype.serialize=function(){return{type:this.constructor.name}},t}(),FillTool=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.applyToContext=function(t,e,n){var o=new Path2D;o.rect(0,0,n.width,n.height),t.fill(o)},e}(Tool),Canvas=function(){function t(){this.currentStyle={color:"#ffffff",lineWidth:1},this.createCanvasElement()}return t.prototype.createCanvasElement=function(){this.canvasElement=document.createElement("canvas"),this.canvasElement.style.width="100%",this.canvasElement.style.height="100%",this.canvasContext=this.canvasElement.getContext("2d"),this.setStyle(this.currentStyle)},t.prototype.setSize=function(t,e){this.canvasElement.width=t,this.canvasElement.height=e},t.prototype.applyMutation=function(t){var e=this;t.checkpoint?this.applyImageData(t.checkpoint):this.imageDataBeforePreview&&this.applyImageData(this.imageDataBeforePreview),this.imageDataBeforePreview=null,t.actions.forEach(function(t){return e.applyAction(t)})},t.prototype.setStyle=function(t){this.currentStyle=__assign({},this.currentStyle,t)},t.prototype.previewAction=function(t){var e;this.imageDataBeforePreview?this.applyImageData(this.imageDataBeforePreview):e=this.getImageData(),this.applyAction(t),e&&(this.imageDataBeforePreview=e)},t.prototype.applyAction=function(t){var e=__assign({},this.currentStyle,t.style);this.context.lineWidth=e.lineWidth,this.context.strokeStyle=e.color,this.context.fillStyle=e.color,t.tool.applyToContext(this.context,t.record,{width:this.canvasElement.width,height:this.canvasElement.height})},Object.defineProperty(t.prototype,"element",{get:function(){return this.canvasElement},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this.canvasContext},enumerable:!0,configurable:!0}),t.prototype.applyImageData=function(t){this.context.putImageData(t,0,0)},t.prototype.getImageData=function(){return this.context.getImageData(0,0,this.element.width,this.element.height)},t}(),History=function(){function t(t){this.actions=[],this.checkpoints=[],this.checkpoints.push({data:t})}return t.prototype.add=function(t){return this.actions.push({action:__assign({},t),id:this.actions.length}),{actions:[t]}},t.prototype.back=function(){this.isActionAndCheckpointOnTopMatch()&&this.checkpoints.pop(),this.actions.pop();for(var t=[],e=this.checkpoints[this.checkpoints.length-1],n=this.actions.length-1;0<=n&&e.actionId!==this.actions[n].id;n-=1)t.push(this.actions[n].action);return{actions:t.reverse(),checkpoint:e.data}},t.prototype.addNewCheckpoint=function(t){this.isActionAndCheckpointOnTopMatch()?this.replaceCheckpointOnTop(t):this.checkpoints.push({data:t,actionId:this.getCurrentActionId()})},t.prototype.getCurrentActionId=function(){return this.actions[this.actions.length-1].id},t.prototype.isActionAndCheckpointOnTopMatch=function(){return this.checkpoints[this.checkpoints.length-1].actionId===this.getCurrentActionId()},t.prototype.replaceCheckpointOnTop=function(t){var e=this.actions[this.actions.length-1].id;this.checkpoints.pop(),this.checkpoints.push({data:t,actionId:e})},t}(),Pixelizer=function(){function t(t){var o=this;this.preview=function(t){o.currentTool&&o.canvas.previewAction({tool:o.currentTool,record:t,style:__assign({},o.style)})},this.finishAction=function(t){if(o.currentTool){var e={tool:o.currentTool,record:t,style:__assign({},o.style)},n=o.history.add(e);o.applyMutation(n),o.newActionListener&&o.newActionListener(e)}},this.adapter=t,this.connector=new InteractionConnector(this.adapter),this.canvas=new Canvas,this.history=new History(this.canvas.getImageData())}return t.prototype.mountCanvasInDOMElement=function(t){t.appendChild(this.canvas.element),this.canvas.setSize(this.canvas.element.scrollWidth,this.canvas.element.scrollHeight),this.history=new History(this.canvas.getImageData()),this.adapter.setInteractionElement(this.canvas.element);var e=this.history.add({tool:new FillTool,record:new InteractionRecord,style:{color:"#ffffff"}});this.applyMutation(e)},t.prototype.setConfig=function(t){t.recorderCreator&&(this.currentRecorder=t.recorderCreator(this.preview,this.finishAction),this.connector.setIteractionHandler(this.currentRecorder)),t.tool&&(this.currentTool=t.tool)},t.prototype.setStyle=function(t){this.style=t,this.canvas.setStyle(t)},t.prototype.applyActions=function(t){var e=this;void 0===t&&(t=[]),t.forEach(function(t){e.applyMutation(e.history.add(t))})},t.prototype.addNewActionListener=function(t){this.newActionListener=t},t.prototype.revertAction=function(){var t=this.history.back();this.applyMutation(t)},t.prototype.applyMutation=function(t){this.canvas.applyMutation(t)},t}(),BrowserInteractionAdapter=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.interactionStarted=!1,e.handleMouseDown=function(t){e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.PressStart,t)),e.interactionStarted=!0},e.handleInteractionStop=function(t){e.interactionStarted&&e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.PressStop,t)),e.interactionStarted=!1},e.handleMouseMove=function(t){e.interactionStarted?e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.MoveDuringPress,t)):e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.Move,t))},e.handleClick=function(t){e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.Press,t))},e.handleWheel=function(t){e.emitInteractionEvent(e.transformWheelEventToInteractionEvent(t))},e}return __extends(e,t),e.prototype.setInteractionElement=function(t){if(!t)throw new Error("Interaction element is not provided");this.elementRect=t.getBoundingClientRect(),t.addEventListener("mousedown",this.handleMouseDown),t.addEventListener("mouseup",this.handleInteractionStop),t.addEventListener("mouseleave",this.handleInteractionStop),t.addEventListener("mousemove",this.handleMouseMove),t.addEventListener("click",this.handleClick),t.addEventListener("wheel",this.handleWheel)},e.prototype.transformWheelEventToInteractionEvent=function(t){return{id:"0",type:0<t.deltaY?InteractionEventType.Increase:InteractionEventType.Decrease}},e.prototype.transformMouseEventToInteractionEvent=function(t,e){return{position:{x:e.clientX-this.elementRect.left,y:e.clientY-this.elementRect.top},id:"0",type:t}},e}(InteractionAdapter),InteractionRecorder=function(){function t(t,e){this.requestPreview=t,this.reportFinishRecord=e}return t.prototype.finishRecord=function(t){this.reportFinishRecord(t)},t.prototype.preview=function(t){this.requestPreview(t)},t.prototype.pressStart=function(t){},t.prototype.moveDuringPress=function(t){},t.prototype.pressStop=function(t){},t.prototype.press=function(t){},t.prototype.move=function(t){},t.prototype.doublePress=function(t){},t.prototype.increase=function(t){},t.prototype.decrease=function(t){},t}(),TwoPointRecord=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.serialize=function(){var t=e.prototype.serialize.call(this);return __assign({},t,{data:{startPoint:this.startPoint,endPoint:this.endPoint}})},t}(InteractionRecord),TwoPointRecorder=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentRecord=new TwoPointRecord,t}return __extends(t,e),t.prototype.pressStart=function(t){this.currentRecord.startPoint=t.position},t.prototype.moveDuringPress=function(t){this.currentRecord.endPoint=t.position,this.preview(this.currentRecord)},t.prototype.pressStop=function(t){this.currentRecord.endPoint=t.position,this.finishRecord(this.currentRecord),this.currentRecord=new TwoPointRecord},t}(InteractionRecorder),NPointRecord=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.points=[],t}return __extends(t,e),t.prototype.serialize=function(){var t=e.prototype.serialize.call(this);return __assign({},t,{data:this.points.slice()})},t}(InteractionRecord),NPointRecorder=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentRecord=new NPointRecord,t}return __extends(t,e),t.prototype.pressStart=function(t){this.currentRecord.points.push(__assign({},t.position))},t.prototype.moveDuringPress=function(t){this.currentRecord.points.push(__assign({},t.position)),this.preview(this.currentRecord)},t.prototype.pressStop=function(t){this.currentRecord.points.push(__assign({},t.position)),this.finishRecord(this.currentRecord),this.currentRecord=new NPointRecord},t}(InteractionRecorder),MAX_SCALAR_VALUE=100,MIN_SCALAR_VALUE=1,PointScalarRecord=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.value=3,t}return __extends(t,e),t.prototype.serialize=function(){var t=e.prototype.serialize.call(this);return __assign({},t,{data:{point:this.point,value:this.value}})},t}(InteractionRecord),PointScalarRecorder=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentRecord=new PointScalarRecord,t.lastValue=3,t}return __extends(t,e),t.prototype.move=function(t){this.currentRecord.point=t.position,this.preview(this.currentRecord)},t.prototype.increase=function(t){this.lastValue=Math.min(MAX_SCALAR_VALUE,this.lastValue+1),this.currentRecord.value=this.lastValue,this.preview(this.currentRecord)},t.prototype.decrease=function(t){this.lastValue=Math.max(MIN_SCALAR_VALUE,this.lastValue-1),this.currentRecord.value=this.lastValue,this.preview(this.currentRecord)},t.prototype.press=function(t){this.currentRecord.point=t.position,this.finishRecord(this.currentRecord),this.currentRecord=new PointScalarRecord,this.currentRecord.value=this.lastValue},t}(InteractionRecorder),Records=Object.freeze({InteractionRecorder:InteractionRecorder,TwoPointRecord:TwoPointRecord,TwoPointRecorder:TwoPointRecorder,NPointRecord:NPointRecord,NPointRecorder:NPointRecorder,PointScalarRecord:PointScalarRecord,PointScalarRecorder:PointScalarRecorder,InteractionRecord:InteractionRecord}),RectangleTool=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.applyToContext=function(t,e){e instanceof TwoPointRecord?this.drawRectBasedOnTwoPoints(t,e):e instanceof PointScalarRecord?this.drawRectBasedOnPointScalar(t,e):n.prototype.applyToContext.call(this,t,e)},t.prototype.drawRectBasedOnTwoPoints=function(t,e){var n=new Path2D;n.rect(e.startPoint.x,e.startPoint.y,e.endPoint.x-e.startPoint.x,e.endPoint.y-e.startPoint.y),t.stroke(n)},t.prototype.drawRectBasedOnPointScalar=function(t,e){var n=new Path2D;n.rect(e.point.x-e.value/2,e.point.y-e.value/2,e.value,e.value),t.stroke(n)},t}(Tool),MultilineTool=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.applyToContext=function(t,e){e instanceof NPointRecord?this.drawLineBasedOnArrayOfPoints(t,e):n.prototype.applyToContext.call(this,t,e)},t.prototype.drawLineBasedOnArrayOfPoints=function(t,e){var n=new Path2D,o=e.points;o.length<1||(n.moveTo(o[0].x,o[0].y),o.slice(1).forEach(function(t){n.lineTo(t.x,t.y)}),t.stroke(n))},t}(Tool),LineTool=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return __extends(t,n),t.prototype.applyToContext=function(t,e){e instanceof TwoPointRecord?this.drawLineBasedOnTwoPoints(t,e):n.prototype.applyToContext.call(this,t,e)},t.prototype.drawLineBasedOnTwoPoints=function(t,e){var n=new Path2D;n.moveTo(e.startPoint.x,e.startPoint.y),n.lineTo(e.endPoint.x,e.endPoint.y),t.stroke(n)},t}(Tool),Tools=Object.freeze({RectangleTool:RectangleTool,MultilineTool:MultilineTool,LineTool:LineTool,Tool:Tool});function serialize(t){return t.serialize()}function deserializeTool(t){var e=Tools;if(!e[t.type])throw new Error("No tool with class '"+t.type+"'");return new e[t.type]}function deserializeRecord(t){var e=Records;if(!e[t.type])throw new Error("No record with class '"+t.type+"'");var n=new e[t.type];switch(t.type){case TwoPointRecord.name:return n.startPoint=t.data.startPoint,n.endPoint=t.data.endPoint,n;case NPointRecord.name:return n.points=t.data.slice(),n;case PointScalarRecord.name:return n.point=t.data.point,n.value=t.data.value,n;case InteractionRecord.name:return n;default:throw new Error("No deserialization strategy for record with class '"+t.type+"'")}}var ActionSerializer=function(){function t(){}return t.serialize=function(t){return{tool:serialize(t.tool),record:serialize(t.record),style:t.style?__assign({},t.style):void 0}},t.deserializeFromObj=function(t){return{tool:deserializeTool(t.tool),record:deserializeRecord(t.record),style:t.style?__assign({},t.style):void 0}},t}();exports.Pixelizer=Pixelizer,exports.BrowserInteractionAdapter=BrowserInteractionAdapter,exports.InteractionRecorder=InteractionRecorder,exports.TwoPointRecord=TwoPointRecord,exports.TwoPointRecorder=TwoPointRecorder,exports.NPointRecord=NPointRecord,exports.NPointRecorder=NPointRecorder,exports.PointScalarRecord=PointScalarRecord,exports.PointScalarRecorder=PointScalarRecorder,exports.InteractionRecord=InteractionRecord,exports.RectangleTool=RectangleTool,exports.MultilineTool=MultilineTool,exports.LineTool=LineTool,exports.Tool=Tool,exports.ActionSerializer=ActionSerializer;
