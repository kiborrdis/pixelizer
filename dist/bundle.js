"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){function __(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(__.prototype=e.prototype,new __)}var InteractionEventType,__assign=function(){return(__assign=Object.assign||function __assign(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};!function(t){t[t.PressStart=1]="PressStart",t[t.MoveDuringPress=2]="MoveDuringPress",t[t.PressStop=3]="PressStop",t[t.Press=4]="Press",t[t.Move=5]="Move",t[t.DoublePress=6]="DoublePress",t[t.Increase=7]="Increase",t[t.Decrease=8]="Decrease"}(InteractionEventType=InteractionEventType||{});var InteractionAdapter=function(){function InteractionAdapter(){for(var t in this.listeners=new Map,InteractionEventType)isNaN(Number(t))&&this.listeners.set(InteractionEventType[t],[])}return InteractionAdapter.prototype.addInteractionListener=function(t,e){this.listeners.get(t).push(e)},InteractionAdapter.prototype.emitInteractionEvent=function(e){this.listeners.get(e.type).forEach(function(t){t(e)})},InteractionAdapter}(),InteractionConnector=function(){function InteractionConnector(t){var e=this;this.handlePressStart=function(t){e.handler&&e.handler.pressStart&&e.handler.pressStart(t)},this.handleMoveDuringPress=function(t){e.handler&&e.handler.moveDuringPress&&e.handler.moveDuringPress(t)},this.handlePressStop=function(t){e.handler&&e.handler.pressStop&&e.handler.pressStop(t)},this.handleMove=function(t){e.handler&&e.handler.move&&e.handler.move(t)},this.handlePress=function(t){e.handler&&e.handler.press&&e.handler.press(t)},this.handleDoublePress=function(t){e.handler&&e.handler.doublePress&&e.handler.doublePress(t)},this.handleIncrease=function(t){e.handler&&e.handler.increase&&e.handler.increase(t)},this.handleDecrease=function(t){e.handler&&e.handler.decrease&&e.handler.decrease(t)},(this.emitter=t).addInteractionListener(InteractionEventType.PressStart,this.handlePressStart),t.addInteractionListener(InteractionEventType.MoveDuringPress,this.handleMoveDuringPress),t.addInteractionListener(InteractionEventType.PressStop,this.handlePressStop),t.addInteractionListener(InteractionEventType.Move,this.handleMove),t.addInteractionListener(InteractionEventType.Press,this.handlePress),t.addInteractionListener(InteractionEventType.DoublePress,this.handleDoublePress),t.addInteractionListener(InteractionEventType.Increase,this.handleIncrease),t.addInteractionListener(InteractionEventType.Decrease,this.handleDecrease)}return InteractionConnector.prototype.setIteractionHandler=function(t){this.handler=t},InteractionConnector}(),Tool=function(){function Tool(){}return Tool.prototype.serialize=function(){return{type:this.constructor.name}},Tool}(),FillTool=function(t){function FillTool(){return null!==t&&t.apply(this,arguments)||this}return __extends(FillTool,t),FillTool.prototype.serialize=function(){return{type:"fill"}},FillTool.prototype.applyToContext=function(t,e,n){var o=new Path2D;o.rect(0,0,n.width,n.height),t.fill(o)},FillTool}(Tool),Canvas=function(){function Canvas(){this.currentStyle={color:"#ffffff",lineWidth:1},this.createCanvasElement()}return Canvas.prototype.createCanvasElement=function(){this.canvasElement=document.createElement("canvas"),this.canvasElement.style.width="100%",this.canvasElement.style.height="100%",this.canvasElement.style.touchAction="none",this.canvasContext=this.canvasElement.getContext("2d"),this.setStyle(this.currentStyle)},Canvas.prototype.setSize=function(t,e){this.canvasElement.width=t,this.canvasElement.height=e},Canvas.prototype.applyMutation=function(t){var e=this;t.checkpoint?this.applyImageData(t.checkpoint):this.imageDataBeforePreview&&this.applyImageData(this.imageDataBeforePreview),this.imageDataBeforePreview=null,t.actions.forEach(function(t){return e.applyAction(t)})},Canvas.prototype.setStyle=function(t){this.currentStyle=__assign(__assign({},this.currentStyle),t)},Canvas.prototype.previewAction=function(t){var e;this.imageDataBeforePreview?this.applyImageData(this.imageDataBeforePreview):e=this.getImageData(),this.applyAction(t),e&&(this.imageDataBeforePreview=e)},Canvas.prototype.resetPreview=function(){this.imageDataBeforePreview&&(this.applyImageData(this.imageDataBeforePreview),this.imageDataBeforePreview=null)},Canvas.prototype.applyAction=function(t){var e=__assign(__assign({},this.currentStyle),t.style);this.context.lineWidth=e.lineWidth,this.context.strokeStyle=e.color,this.context.fillStyle=e.color,this.context.lineCap="round",this.context.lineJoin="round",t.tool.applyToContext(this.context,t.record,{width:this.canvasElement.width,height:this.canvasElement.height,baseLineWidth:e.lineWidth})},Object.defineProperty(Canvas.prototype,"element",{get:function(){return this.canvasElement},enumerable:!1,configurable:!0}),Object.defineProperty(Canvas.prototype,"context",{get:function(){return this.canvasContext},enumerable:!1,configurable:!0}),Canvas.prototype.applyImageData=function(t){this.context.putImageData(t,0,0)},Canvas.prototype.getImageData=function(){return this.context.getImageData(0,0,this.element.width,this.element.height)},Canvas}(),History=function(){function History(t){this.actions=[],this.checkpoints=[],this.checkpoints.push({data:t})}return History.prototype.add=function(t){return this.actions.push({action:__assign({},t),id:this.actions.length}),{actions:[t]}},History.prototype.back=function(){this.isActionAndCheckpointOnTopMatch()&&this.checkpoints.pop(),this.actions.pop();for(var t=[],e=this.checkpoints[this.checkpoints.length-1],n=this.actions.length-1;0<=n&&e.actionId!==this.actions[n].id;--n)t.push(this.actions[n].action);return{actions:t.reverse(),checkpoint:e.data}},History.prototype.addNewCheckpoint=function(t){this.isActionAndCheckpointOnTopMatch()?this.replaceCheckpointOnTop(t):this.checkpoints.push({data:t,actionId:this.getCurrentActionId()})},History.prototype.getCurrentActionId=function(){return this.actions[this.actions.length-1].id},History.prototype.isActionAndCheckpointOnTopMatch=function(){return this.checkpoints[this.checkpoints.length-1].actionId===this.getCurrentActionId()},History.prototype.replaceCheckpointOnTop=function(t){var e=this.actions[this.actions.length-1].id;this.checkpoints.pop(),this.checkpoints.push({data:t,actionId:e})},History}(),Pixelizer=function(){function Pixelizer(t){var o=this;this.interactionsAllowed=!0,this.preview=function(t){o.interactionsAllowed&&o.currentTool&&o.canvas.previewAction({tool:o.currentTool,record:t,style:__assign({},o.style)})},this.finishAction=function(t){var e,n;o.interactionsAllowed&&o.currentTool&&(e={tool:o.currentTool,record:t,style:__assign({},o.style)},n=o.history.add(e),o.applyMutation(n),o.newActionListener&&o.newActionListener(e))},this.adapter=t,this.connector=new InteractionConnector(this.adapter),this.canvas=new Canvas,this.history=new History(this.canvas.getImageData())}return Pixelizer.prototype.mountCanvasInDOMElement=function(t){t.appendChild(this.canvas.element),this.canvas.setSize(this.canvas.element.scrollWidth,this.canvas.element.scrollHeight),this.history=new History(this.canvas.getImageData()),this.adapter.setInteractionElement(this.canvas.element);var e=this.history.add({tool:new FillTool,record:{},style:{color:"#ffffff"}});this.applyMutation(e)},Pixelizer.prototype.setConfig=function(t){t.recorderCreator&&(this.currentRecorder=t.recorderCreator(this.preview,this.finishAction),this.connector.setIteractionHandler(this.currentRecorder)),t.tool&&(this.currentTool=t.tool)},Pixelizer.prototype.setStyle=function(t){this.style=t,this.canvas.setStyle(t)},Pixelizer.prototype.enableInteractions=function(t){this.interactionsAllowed=t},Pixelizer.prototype.clear=function(){var t={tool:new FillTool,record:{},style:{color:"#ffffff"}};this.applyMutation(this.history.add(t)),this.history=new History(this.canvas.getImageData()),this.history.add(t)},Pixelizer.prototype.applyActions=function(t){var e=this;void 0===t&&(t=[]),t.forEach(function(t){e.applyMutation(e.history.add(t))})},Pixelizer.prototype.addNewActionListener=function(t){this.newActionListener=t},Pixelizer.prototype.revertAction=function(){var t=this.history.back();this.applyMutation(t)},Pixelizer.prototype.applyMutation=function(t){this.canvas.applyMutation(t)},Pixelizer}(),BrowserInteractionAdapter=function(t){function BrowserInteractionAdapter(){var e=null!==t&&t.apply(this,arguments)||this;return e.interactionStarted=!1,e.handleMouseDown=function(t){t.preventDefault(),e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.PressStart,t)),e.interactionStarted=!0},e.handleInteractionStop=function(t){t.preventDefault(),e.interactionStarted&&e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.PressStop,t)),e.interactionStarted=!1},e.handleMouseMove=function(t){t.preventDefault(),e.interactionStarted?e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.MoveDuringPress,t)):e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.Move,t))},e.handleClick=function(t){e.emitInteractionEvent(e.transformMouseEventToInteractionEvent(InteractionEventType.Press,t))},e.handleWheel=function(t){e.emitInteractionEvent(e.transformWheelEventToInteractionEvent(t))},e}return __extends(BrowserInteractionAdapter,t),BrowserInteractionAdapter.prototype.setInteractionElement=function(t){if(!t)throw new Error("Interaction element is not provided");this.element=t,this.elementRect=t.getBoundingClientRect(),t.addEventListener("pointerdown",this.handleMouseDown),t.addEventListener("pointerup",this.handleInteractionStop),t.addEventListener("pointerout",this.handleInteractionStop),t.addEventListener("pointermove",this.handleMouseMove),t.addEventListener("click",this.handleClick),t.addEventListener("wheel",this.handleWheel)},BrowserInteractionAdapter.prototype.transformWheelEventToInteractionEvent=function(t){return{id:"0",type:0<t.deltaY?InteractionEventType.Increase:InteractionEventType.Decrease}},BrowserInteractionAdapter.prototype.transformMouseEventToInteractionEvent=function(t,e){this.elementRect=this.element.getBoundingClientRect();var n=e.clientX-this.elementRect.left,o=e.clientY-this.elementRect.top;return{position:{x:Math.floor(n),y:Math.floor(o)},id:"0",type:t,pressure:e.pressure}},BrowserInteractionAdapter}(InteractionAdapter),InteractionRecorder=function(){function InteractionRecorder(t,e){this.requestPreview=t,this.reportFinishRecord=e}return InteractionRecorder.prototype.finishRecord=function(t){this.reportFinishRecord(t)},InteractionRecorder.prototype.preview=function(t){this.requestPreview(t)},InteractionRecorder.prototype.pressStart=function(t){},InteractionRecorder.prototype.moveDuringPress=function(t){},InteractionRecorder.prototype.pressStop=function(t){},InteractionRecorder.prototype.press=function(t){},InteractionRecorder.prototype.move=function(t){},InteractionRecorder.prototype.doublePress=function(t){},InteractionRecorder.prototype.increase=function(t){},InteractionRecorder.prototype.decrease=function(t){},InteractionRecorder}(),createTwoPointRecord=function(){return{startPoint:{x:0,y:0},endPoint:{x:0,y:0}}},isTwoPointRecord=function(t){return"startPoint"in t&&"endPoint"in t},TwoPointRecorder=function(e){function TwoPointRecorder(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentRecord=createTwoPointRecord(),t}return __extends(TwoPointRecorder,e),TwoPointRecorder.prototype.pressStart=function(t){this.currentRecord.startPoint=t.position},TwoPointRecorder.prototype.moveDuringPress=function(t){this.currentRecord.endPoint=t.position,this.preview(this.currentRecord)},TwoPointRecorder.prototype.pressStop=function(t){this.currentRecord.endPoint=t.position,this.finishRecord(this.currentRecord),this.currentRecord=createTwoPointRecord()},TwoPointRecorder}(InteractionRecorder),createNPointRecord=function(){return{points:[]}},isNPointRecord=function(t){return"points"in t},NPointRecorder=function(e){function NPointRecorder(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentRecord=createNPointRecord(),t}return __extends(NPointRecorder,e),NPointRecorder.prototype.pressStart=function(t){this.currentRecord.points.push(__assign({},t.position))},NPointRecorder.prototype.moveDuringPress=function(t){this.currentRecord.points.push(__assign({},t.position)),this.preview(this.currentRecord)},NPointRecorder.prototype.pressStop=function(t){this.currentRecord.points.push(__assign({},t.position)),this.finishRecord(this.currentRecord),this.currentRecord=createNPointRecord()},NPointRecorder}(InteractionRecorder),MAX_SCALAR_VALUE=100,MIN_SCALAR_VALUE=1,createPointScalarRecord=function(){return{point:{x:0,y:0},value:3}},isPointScalarRecord=function(t){return"value"in t&&"point"in t},PointScalarRecorder=function(e){function PointScalarRecorder(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentRecord=createPointScalarRecord(),t.lastValue=3,t}return __extends(PointScalarRecorder,e),PointScalarRecorder.prototype.move=function(t){this.currentRecord.point=t.position,this.preview(this.currentRecord)},PointScalarRecorder.prototype.increase=function(t){this.lastValue=Math.min(MAX_SCALAR_VALUE,this.lastValue+1),this.currentRecord.value=this.lastValue,this.preview(this.currentRecord)},PointScalarRecorder.prototype.decrease=function(t){this.lastValue=Math.max(MIN_SCALAR_VALUE,this.lastValue-1),this.currentRecord.value=this.lastValue,this.preview(this.currentRecord)},PointScalarRecorder.prototype.press=function(t){this.currentRecord.point=t.position,this.finishRecord(this.currentRecord),this.currentRecord=createPointScalarRecord(),this.currentRecord.value=this.lastValue},PointScalarRecorder}(InteractionRecorder),createNPressurePointsRecord=function(){return{points:[],type:"npp"}},isNPressurePointsRecord=function(t){return"npp"===t.type},NPressurePointsRecorder=function(e){function NPressurePointsRecorder(){var t=null!==e&&e.apply(this,arguments)||this;return t.currentRecord=createNPressurePointsRecord(),t}return __extends(NPressurePointsRecorder,e),NPressurePointsRecorder.prototype.pressStart=function(t){this.currentRecord.points.push({p:__assign({},t.position),pressure:t.pressure})},NPressurePointsRecorder.prototype.moveDuringPress=function(t){this.currentRecord.points.push({p:__assign({},t.position),pressure:t.pressure}),this.preview(this.currentRecord)},NPressurePointsRecorder.prototype.pressStop=function(t){this.currentRecord.points.push({p:__assign({},t.position),pressure:t.pressure}),this.finishRecord(this.currentRecord),this.currentRecord=createNPressurePointsRecord()},NPressurePointsRecorder}(InteractionRecorder),RectangleTool=function(t){function RectangleTool(){return null!==t&&t.apply(this,arguments)||this}return __extends(RectangleTool,t),RectangleTool.prototype.applyToContext=function(t,e){isTwoPointRecord(e)?this.drawRectBasedOnTwoPoints(t,e):isPointScalarRecord(e)&&this.drawRectBasedOnPointScalar(t,e)},RectangleTool.prototype.drawRectBasedOnTwoPoints=function(t,e){var n=new Path2D;n.rect(e.startPoint.x,e.startPoint.y,e.endPoint.x-e.startPoint.x,e.endPoint.y-e.startPoint.y),t.stroke(n)},RectangleTool.prototype.drawRectBasedOnPointScalar=function(t,e){var n=new Path2D;n.rect(e.point.x-e.value/2,e.point.y-e.value/2,e.value,e.value),t.stroke(n)},RectangleTool}(Tool),MultilineTool=function(t){function MultilineTool(){return null!==t&&t.apply(this,arguments)||this}return __extends(MultilineTool,t),MultilineTool.prototype.applyToContext=function(t,e,n){isNPressurePointsRecord(e)&&this.drawPressureAwareLine(t,e,n),isNPointRecord(e)&&this.drawLineBasedOnArrayOfPoints(t,e)},MultilineTool.prototype.drawPressureAwareLine=function(o,t,e){var n=e.baseLineWidth||3,r=n/3,i=3*n,s=t.points;s.length<1||(o.lineWidth=(i-r)*s[0].pressure+r,s.forEach(function(t,e){var n;e-1<0||(o.lineWidth=(i-r)*t.pressure+r,(n=new Path2D).moveTo(s[e-1].p.x,s[e-1].p.y),n.lineTo(t.p.x,t.p.y),o.stroke(n))}))},MultilineTool.prototype.drawLineBasedOnArrayOfPoints=function(t,e){var n=new Path2D,o=e.points;o.length<1||(n.moveTo(o[0].x,o[0].y),o.slice(1).forEach(function(t){n.lineTo(t.x,t.y)}),t.stroke(n))},MultilineTool}(Tool),LineTool=function(t){function LineTool(){return null!==t&&t.apply(this,arguments)||this}return __extends(LineTool,t),LineTool.prototype.applyToContext=function(t,e){this.drawLineBasedOnTwoPoints(t,e)},LineTool.prototype.drawLineBasedOnTwoPoints=function(t,e){var n=new Path2D;n.moveTo(e.startPoint.x,e.startPoint.y),n.lineTo(e.endPoint.x,e.endPoint.y),t.stroke(n)},LineTool}(Tool),Tools=Object.freeze({__proto__:null,RectangleTool:RectangleTool,MultilineTool:MultilineTool,LineTool:LineTool,Tool:Tool});function serialize(t){return t.serialize()}function deserializeTool(t){var e=Tools;if(!e[t.type])throw new Error("No tool with class '"+t.type+"'");return new e[t.type]}function deserializeRecord(t){return __assign({},t)}var ActionSerializer=function(){function ActionSerializer(){}return ActionSerializer.serialize=function(t){return{tool:serialize(t.tool),record:__assign({},t.record),style:t.style?__assign({},t.style):void 0}},ActionSerializer.deserializeFromObj=function(t){return{tool:deserializeTool(t.tool),record:deserializeRecord(t.record),style:t.style?__assign({},t.style):void 0}},ActionSerializer}();exports.ActionSerializer=ActionSerializer,exports.BrowserInteractionAdapter=BrowserInteractionAdapter,exports.InteractionRecorder=InteractionRecorder,exports.LineTool=LineTool,exports.MultilineTool=MultilineTool,exports.NPointRecorder=NPointRecorder,exports.NPressurePointsRecorder=NPressurePointsRecorder,exports.Pixelizer=Pixelizer,exports.PointScalarRecorder=PointScalarRecorder,exports.RectangleTool=RectangleTool,exports.Tool=Tool,exports.TwoPointRecorder=TwoPointRecorder,exports.createNPointRecord=createNPointRecord,exports.createNPressurePointsRecord=createNPressurePointsRecord,exports.createPointScalarRecord=createPointScalarRecord,exports.createTwoPointRecord=createTwoPointRecord,exports.isNPointRecord=isNPointRecord,exports.isNPressurePointsRecord=isNPressurePointsRecord,exports.isPointScalarRecord=isPointScalarRecord,exports.isTwoPointRecord=isTwoPointRecord;
